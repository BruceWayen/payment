<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.unit.dao.SysUsersMapper">
    <resultMap id="BaseResultMap" type="com.unit.domain.SysUsers">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="contract_no" jdbcType="BIGINT" property="contractNo"/>
        <result column="user_name" jdbcType="CHAR" property="userName"/>
        <result column="sex" jdbcType="INTEGER" property="sex"/>
        <result column="login_no" jdbcType="CHAR" property="loginNo"/>
        <result column="pass_word" jdbcType="CHAR" property="passWord"/>
        <result column="id_iccid" jdbcType="CHAR" property="idIccid"/>
        <result column="dept_id" jdbcType="INTEGER" property="deptId"/>
        <result column="phone_no" jdbcType="CHAR" property="phoneNo"/>
        <result column="user_satus" jdbcType="INTEGER" property="userSatus"/>
        <result column="register_time" jdbcType="TIMESTAMP" property="registerTime"/>
        <result column="register_type" jdbcType="INTEGER" property="registerType"/>
        <result column="role_id" jdbcType="INTEGER" property="roleId"/>
        <result column="last_login_time" jdbcType="TIMESTAMP" property="lastLoginTime"/>
    </resultMap>
    <resultMap id="MenuResultMap" type="com.unit.domain.SysMenu">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="menu_super_id" jdbcType="INTEGER" property="menuSuperId"/>
        <result column="menu_status" jdbcType="INTEGER" property="menuStatus"/>
        <result column="menu_sort" jdbcType="INTEGER" property="menuSort"/>
        <result column="menu_name" jdbcType="CHAR" property="menuName"/>
        <result column="menu_icon_url" jdbcType="CHAR" property="menuIconUrl"/>
        <result column="menu_url" jdbcType="CHAR" property="menuUrl"/>
        <result column="count_childrens" jdbcType="CHAR" property="countChildrens"/>
    </resultMap>
    <select id="getUserByName" parameterType="string" resultMap="BaseResultMap">
      select * from sys_users where user_name = #{userName} AND user_satus='0'
    </select>
    <select id="getMenuByUserId" resultMap="MenuResultMap">
        SELECT
        m.id,m.menu_super_id,m.menu_status,m.menu_sort,m.menu_name,m.menu_icon_url,m.menu_url,
        (select count(1) from sys_menu s where s.menu_super_id !=0 and s.menu_super_id=m.id) as count_childrens
        FROM
        sys_menu m
        LEFT JOIN sys_action a ON a.menu_id = m.id
        LEFT JOIN sys_role_action ra ON ra.action_id = a.id
        LEFT JOIN sys_role r ON r.id = ra.role_id
        LEFT JOIN sys_user_role ur ON ur.role_id = r.id
        LEFT JOIN sys_users u ON u.id = ur.user_id
        WHERE u.id=#{id}
        AND m.menu_status =#{menuStatus}
        <if test="menuSuperId !=null ">
            AND m.menu_super_id = #{menuSuperId}
        </if>
    </select>

    <select id="getChildrenMenu" resultType="com.unit.domain.SysMenu">

        select m.menu_no,m.menu_name,m.parent_no,m.icon_class,m.menu_url,
        (select count(1) from s_menu s where s.parent_no !=0 and s.parent_no=m.menu_no) as countChildrens
        from s_menu m
        left join s_role_menu rm on m.menu_no=rm.menu_no
        left join s_role r on rm.role_id=r.id
        left join s_user_role ur on r.id=ur.role_id
        left join s_user u on ur.user_id=u.id
        where m.is_disenable=0 and u.id=#{userId} and m.parent_no=#{pid} and m.menu_no not in
        (select tt.menu_no from (select m.menu_no,(select count(parent_no) from s_menu sp
        where sp.is_disenable=0 and sp.parent_no=m.menu_no and m.parent_no=0)
        countch from s_menu m where m.parent_no=0) tt where countch=0)
    </select>
    <update id="editPassword">
    update s_user set user_password =#{psw} where id=#{userId}
  </update>
    <!-- 重置用户密码 -->
    <update id="resetPassword" parameterType="com.unit.domain.SysUsers">
    update s_user set user_password=#{user.user_password} where id = #{user.id}
  </update>

    <!-- 重置用户密码,默认为123456 -->
    <update id="reset" parameterType="java.lang.Integer">
    update s_user set user_password='4QrcOUm6Wau+VuBX8g+IPg==' where teach_stu_id = #{id}
  </update>

    <!-- 新增管理员 -->
    <insert id="addUser" parameterType="com.unit.domain.SysUsers" useGeneratedKeys="true">
        insert into s_user(user_account,user_name,phone_no,user_password) values
        (#{user.user_account},#{user.user_name},#{user.phone_no},#{user.user_password})
        <selectKey keyProperty="id" resultType="java.lang.Integer">
            select
            LAST_INSERT_ID()
        </selectKey>
    </insert>

    <!-- 查询报名老师ID -->
    <select id="getUserId" resultType="int" parameterType="java.lang.String">
    select id from s_user where user_account=#{userName} and is_disenable = '0'
  </select>


    <!-- 添加权限 -->
    <insert id="addUserRole" parameterType="com.unit.domain.SysUserRole">
    insert into s_user_role (user_id,role_id) values
    (#{userRole.user_id},#{userRole.role_id})
  </insert>

    <!-- 查询管理员总数 -->
    <select id="getUserListSize" resultType="long">
    SELECT COUNT(*) FROM s_user u JOIN s_user_role r ON u.id=r.user_id WHERE r.role_id=2 and u.is_disenable = '0'
  </select>

    <!-- 查询管理员信息 -->
    <select id="getUserList" resultMap="BaseResultMap">
        SELECT
            u.*
        FROM
            sys_users u
        JOIN sys_user_role r ON u.id = r.user_id
    </select>

    <!-- 修改管理员信息 -->
    <update id="editUser" parameterType="com.unit.domain.SysUsers">
    update s_user set user_name=#{user.user_name},phone_no=#{user.phone_no} where id=#{user.id}
  </update>

    <!-- 删除管理员权限 -->
    <delete id="deleteTeacherRole" parameterType="int">
    delete from s_user_role where user_id=#{id}
  </delete>
    <!-- 逻辑删除管理员 -->
    <!--
    <delete id="deleteTeacher">
        delete from s_user where id=#{id}
    </delete>
     -->
    <update id="deleteTeacher" parameterType="java.lang.Integer">
    update s_user set is_disenable='1' where id = #{id}
  </update>

    <!-- 添加操作记录 -->
    <insert id="addOperate" parameterType="com.unit.domain.SysOperate">
    insert into t_operate(oper_time,oper_user,oper_module,content,remark)
    values(now(),#{oper_user},#{oper_module},#{content},#{remark})
  </insert>

    <!-- 根据账号检查原密码是否正确   这里只做查询-->
    <select id="findPwdByName" resultType="java.lang.String">
    select user_password from s_user where user_account = #{user_account}
  </select>

    <!-- 根据账号修改新的密码 -->
    <update id="changePwd" parameterType="com.unit.domain.SysUsers">
    update sys_users set user_password = #{user_password} where user_account = #{user_account}
  </update>

    <!--获取权限ID-->
    <select id="getRoleIdByUserId" resultType="int">
    select role_id from sys_user_role where user_id=#{userId}
  </select>


</mapper>